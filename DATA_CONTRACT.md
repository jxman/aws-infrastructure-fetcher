# AWS Data Fetcher - Data Contract

**Version**: 1.5.1
**Schema Version**: 1.4.0
**Last Updated**: 2025-10-13
**Status**: Stable

## Purpose

This document defines the data contract for JSON files generated by **nodejs-aws-fetcher**. It serves as the formal specification for any consumer applications (reporters, dashboards, analysis tools) that read this data.

## Stability Guarantees

### Stable (Breaking Changes Require Major Version)

- Root-level field names in all output files
- Required fields will remain required
- Data types of existing fields
- ISO 8601 timestamp format
- Source attribution (`source` field)

### Backward Compatible Changes (Minor Version)

- Addition of new optional fields
- Addition of new root-level keys
- Enhancement of nested objects with new properties
- Addition of new metadata fields

### Breaking Changes (Major Version Bump)

- Removal of existing fields
- Renaming of fields
- Changing data types
- Changing file formats
- Restructuring object hierarchies

## Version History

### Schema v1.4.0 (Current)

**Added:**

- `availabilityZones` count per region
- `launchDate` per region (RFC 822 format)
- `blogUrl` per region (AWS announcement link)
- Service names dynamically fetched from SSM

**Changed:**

- Services in `complete-data.json` are now codes only (not full objects)
- Full service objects with names available in `services.json`

### Schema v1.3.0

**Removed:**

- EC2 comparison data
- Dual-source region discovery

**Changed:**

- `source` is now always "ssm"

### Schema v1.2.0

**Added:**

- 24-hour caching system
- Service-by-region mapping
- Runtime tracking

### Schema v1.0.0

**Initial schema:**

- Region discovery
- Service discovery
- Basic metadata

## Output Files

| File | Purpose | Size | Always Generated |
|------|---------|------|-----------------|
| `regions.json` | Region list with metadata | ~8KB | Yes |
| `services.json` | Service list with official names | ~8KB | Yes |
| `complete-data.json` | **Single source of truth** | ~12KB (no mapping)<br>~400KB (with mapping) | Yes |
| `.cache-services-by-region.json` | 24-hour cache (auto-managed) | ~400KB | Only with `-m` flag |

**Important**: `complete-data.json` is the **single source of truth**. All other files are convenience subsets.

## Data Schemas

### 1. regions.json

**Purpose**: Lightweight list of all AWS regions with metadata

**Schema**:

```json
{
  "count": {
    "type": "number",
    "required": true,
    "description": "Total number of regions discovered",
    "constraints": {
      "minimum": 1,
      "typical": 38
    }
  },
  "regions": {
    "type": "array",
    "required": true,
    "description": "Array of region objects",
    "items": {
      "type": "object",
      "required": true,
      "properties": {
        "code": {
          "type": "string",
          "required": true,
          "description": "AWS region code",
          "pattern": "^[a-z]{2}-[a-z]+-\\d+$",
          "examples": ["us-east-1", "eu-west-3", "ap-southeast-2"]
        },
        "name": {
          "type": "string",
          "required": true,
          "description": "Official AWS region name",
          "examples": ["US East (N. Virginia)", "Europe (Paris)"]
        },
        "availabilityZones": {
          "type": "number",
          "required": true,
          "description": "Number of Availability Zones in this region",
          "constraints": {
            "minimum": 0,
            "typical": 3
          },
          "examples": [3, 4, 6]
        },
        "launchDate": {
          "type": "string|null",
          "required": true,
          "description": "Region launch date in RFC 822 format (from AWS RSS feed)",
          "format": "RFC 822",
          "examples": ["Wed, 9 Nov 2011 19:00:00 GMT"],
          "nullable": true,
          "note": "null for China and GovCloud regions (not in public RSS feed)"
        },
        "blogUrl": {
          "type": "string|null",
          "required": true,
          "description": "AWS blog announcement URL for this region",
          "format": "URL (https://)",
          "examples": ["https://aws.amazon.com/blogs/aws/now-open-aws-asia-pacific-melbourne-region/"],
          "nullable": true,
          "note": "null for China and GovCloud regions"
        }
      }
    }
  },
  "source": {
    "type": "string",
    "required": true,
    "description": "Data source identifier",
    "enum": ["ssm"],
    "note": "Always 'ssm' since v1.3.0"
  },
  "timestamp": {
    "type": "string",
    "required": true,
    "description": "ISO 8601 timestamp of data generation",
    "format": "ISO 8601 (UTC)",
    "example": "2025-10-12T16:05:49.104Z"
  }
}
```

**Full Example**:

```json
{
  "count": 38,
  "regions": [
    {
      "code": "us-east-1",
      "name": "US East (N. Virginia)",
      "availabilityZones": 6,
      "launchDate": "Fri, 25 Aug 2006 19:00:00 GMT",
      "blogUrl": "https://docs.aws.amazon.com/global-infrastructure/latest/regions/doc-history.html"
    },
    {
      "code": "eu-west-3",
      "name": "Europe (Paris)",
      "availabilityZones": 3,
      "launchDate": "Mon, 18 Dec 2017 19:00:00 GMT",
      "blogUrl": "https://aws.amazon.com/blogs/aws/now-open-aws-eu-paris-region/"
    },
    {
      "code": "cn-north-1",
      "name": "China (Beijing)",
      "availabilityZones": 3,
      "launchDate": null,
      "blogUrl": null
    }
  ],
  "source": "ssm",
  "timestamp": "2025-10-12T16:05:49.104Z"
}
```

### 2. services.json

**Purpose**: List of all AWS services with official names

**Schema**:

```json
{
  "count": {
    "type": "number",
    "required": true,
    "description": "Total number of services discovered",
    "constraints": {
      "minimum": 1,
      "typical": 395
    }
  },
  "services": {
    "type": "array",
    "required": true,
    "description": "Array of service objects",
    "items": {
      "type": "object",
      "required": true,
      "properties": {
        "code": {
          "type": "string",
          "required": true,
          "description": "AWS service code (kebab-case)",
          "pattern": "^[a-z0-9-]+$",
          "examples": ["ec2", "s3", "lambda", "bedrock"]
        },
        "name": {
          "type": "string",
          "required": true,
          "description": "Official AWS service name (from SSM Parameter Store)",
          "examples": [
            "Amazon Elastic Compute Cloud (EC2)",
            "Amazon Simple Storage Service (S3)",
            "AWS Lambda"
          ],
          "note": "Dynamically fetched from SSM, always current"
        }
      }
    }
  },
  "source": {
    "type": "string",
    "required": true,
    "description": "Data source identifier",
    "enum": ["ssm"]
  },
  "timestamp": {
    "type": "string",
    "required": true,
    "description": "ISO 8601 timestamp of data generation",
    "format": "ISO 8601 (UTC)"
  }
}
```

**Full Example**:

```json
{
  "count": 395,
  "services": [
    {
      "code": "ec2",
      "name": "Amazon Elastic Compute Cloud (EC2)"
    },
    {
      "code": "s3",
      "name": "Amazon Simple Storage Service (S3)"
    },
    {
      "code": "lambda",
      "name": "AWS Lambda"
    }
  ],
  "source": "ssm",
  "timestamp": "2025-10-12T16:05:59.777Z"
}
```

### 3. complete-data.json (Single Source of Truth)

**Purpose**: Comprehensive dataset combining all metadata, including optional service-by-region mapping

**Schema**:

```json
{
  "metadata": {
    "type": "object",
    "required": true,
    "description": "Tool metadata and execution information",
    "properties": {
      "timestamp": {
        "type": "string",
        "required": true,
        "format": "ISO 8601 (UTC)"
      },
      "tool": {
        "type": "string",
        "required": true,
        "enum": ["nodejs-aws-fetcher"]
      },
      "version": {
        "type": "string",
        "required": true,
        "description": "Schema version (not package version)",
        "pattern": "^\\d+\\.\\d+\\.\\d+$",
        "example": "1.4.0"
      }
    }
  },
  "regions": {
    "type": "object",
    "required": false,
    "description": "Region data (present unless --services-only used)",
    "properties": {
      "count": {
        "type": "number",
        "required": true
      },
      "regions": {
        "type": "array",
        "required": true,
        "description": "Full region objects with all metadata",
        "items": {
          "type": "object",
          "description": "Same structure as regions.json region objects"
        }
      },
      "source": {
        "type": "string",
        "required": true,
        "enum": ["ssm"]
      },
      "timestamp": {
        "type": "string",
        "required": true,
        "format": "ISO 8601 (UTC)"
      }
    }
  },
  "services": {
    "type": "object",
    "required": false,
    "description": "Service data (present unless --regions-only used)",
    "properties": {
      "count": {
        "type": "number",
        "required": true
      },
      "services": {
        "type": "array",
        "required": true,
        "description": "Service codes only (for compactness)",
        "items": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$"
        },
        "note": "For full service objects with names, see services.json"
      },
      "source": {
        "type": "string",
        "required": true,
        "enum": ["ssm"]
      },
      "timestamp": {
        "type": "string",
        "required": true,
        "format": "ISO 8601 (UTC)"
      }
    }
  },
  "servicesByRegion": {
    "type": "object",
    "required": false,
    "description": "Service-by-region mapping (only present with --include-service-mapping flag)",
    "properties": {
      "byRegion": {
        "type": "object",
        "required": true,
        "description": "Service availability per region",
        "patternProperties": {
          "^[a-z]{2}-[a-z]+-\\d+$": {
            "type": "object",
            "properties": {
              "regionCode": {
                "type": "string",
                "required": true
              },
              "serviceCount": {
                "type": "number",
                "required": true,
                "description": "Number of services available in this region"
              },
              "services": {
                "type": "array",
                "required": true,
                "description": "Array of service codes available in this region",
                "items": {
                  "type": "string"
                }
              },
              "lastFetched": {
                "type": "string",
                "required": true,
                "description": "Timestamp when this region data was fetched (for caching)",
                "format": "ISO 8601 (UTC)"
              }
            }
          }
        }
      },
      "summary": {
        "type": "object",
        "required": true,
        "description": "Summary statistics for service-by-region mapping",
        "properties": {
          "totalRegions": {
            "type": "number",
            "required": true
          },
          "totalServices": {
            "type": "number",
            "required": true
          },
          "averageServicesPerRegion": {
            "type": "number",
            "required": true,
            "description": "Rounded to nearest integer"
          },
          "cachedRegions": {
            "type": "number",
            "required": true,
            "description": "Number of regions loaded from cache"
          },
          "fetchedRegions": {
            "type": "number",
            "required": true,
            "description": "Number of regions fetched fresh from SSM"
          },
          "timestamp": {
            "type": "string",
            "required": true,
            "format": "ISO 8601 (UTC)"
          }
        }
      }
    }
  }
}
```

**Full Example (Without Service Mapping)**:

```json
{
  "metadata": {
    "timestamp": "2025-10-12T16:05:45.980Z",
    "tool": "nodejs-aws-fetcher",
    "version": "1.4.0"
  },
  "regions": {
    "count": 38,
    "regions": [
      {
        "code": "us-east-1",
        "name": "US East (N. Virginia)",
        "availabilityZones": 6,
        "launchDate": "Fri, 25 Aug 2006 19:00:00 GMT",
        "blogUrl": "https://docs.aws.amazon.com/global-infrastructure/latest/regions/doc-history.html"
      }
    ],
    "source": "ssm",
    "timestamp": "2025-10-12T16:05:49.104Z"
  },
  "services": {
    "count": 395,
    "services": ["ec2", "s3", "lambda"],
    "source": "ssm",
    "timestamp": "2025-10-12T16:05:59.777Z"
  }
}
```

**Full Example (With Service Mapping)**:

```json
{
  "metadata": {
    "timestamp": "2025-10-12T16:05:45.980Z",
    "tool": "nodejs-aws-fetcher",
    "version": "1.4.0"
  },
  "regions": {
    "count": 38,
    "regions": [
      {
        "code": "us-east-1",
        "name": "US East (N. Virginia)",
        "availabilityZones": 6,
        "launchDate": "Fri, 25 Aug 2006 19:00:00 GMT",
        "blogUrl": "https://docs.aws.amazon.com/global-infrastructure/latest/regions/doc-history.html"
      }
    ],
    "source": "ssm",
    "timestamp": "2025-10-12T16:05:49.104Z"
  },
  "services": {
    "count": 395,
    "services": ["ec2", "s3", "lambda"],
    "source": "ssm",
    "timestamp": "2025-10-12T16:05:59.777Z"
  },
  "servicesByRegion": {
    "byRegion": {
      "us-east-1": {
        "regionCode": "us-east-1",
        "serviceCount": 268,
        "services": ["ec2", "s3", "lambda", "..."],
        "lastFetched": "2025-10-12T16:10:23.456Z"
      }
    },
    "summary": {
      "totalRegions": 38,
      "totalServices": 395,
      "averageServicesPerRegion": 227,
      "cachedRegions": 0,
      "fetchedRegions": 38,
      "timestamp": "2025-10-12T16:10:45.123Z"
    }
  }
}
```

## Validation Rules

### All Output Files Must Have

1. **Valid JSON**: All files are valid JSON (parseable by `JSON.parse()`)
2. **Timestamps**: ISO 8601 format in UTC timezone
3. **Count Matches Length**: `count` field equals array length
4. **Source Attribution**: `source` field present and non-empty
5. **Required Fields**: All required fields present (no undefined/missing keys)

### Region Validation

```javascript
function isValidRegion(region) {
  return (
    typeof region.code === 'string' &&
    region.code.match(/^[a-z]{2}-[a-z]+-\d+$/) !== null &&
    typeof region.name === 'string' &&
    region.name.length > 0 &&
    typeof region.availabilityZones === 'number' &&
    region.availabilityZones >= 0 &&
    (region.launchDate === null || typeof region.launchDate === 'string') &&
    (region.blogUrl === null || (typeof region.blogUrl === 'string' && region.blogUrl.startsWith('https://')))
  );
}
```

### Service Validation

```javascript
function isValidService(service) {
  return (
    typeof service.code === 'string' &&
    service.code.match(/^[a-z0-9-]+$/) !== null &&
    typeof service.name === 'string' &&
    service.name.length > 0
  );
}
```

### Complete Data Validation

```javascript
function isValidCompleteData(data) {
  return (
    data.metadata &&
    data.metadata.tool === 'nodejs-aws-fetcher' &&
    typeof data.metadata.version === 'string' &&
    data.metadata.version.match(/^\d+\.\d+\.\d+$/) !== null &&
    typeof data.metadata.timestamp === 'string' &&
    // regions and services are optional (depend on CLI flags)
    (data.regions === undefined || (data.regions.count === data.regions.regions.length))
  );
}
```

## Data Source Information

### SSM Parameter Store Paths

**Regions:**

- Path: `/aws/service/global-infrastructure/regions`
- Long names: `/aws/service/global-infrastructure/regions/{code}/longName`

**Availability Zones:**

- Path: `/aws/service/global-infrastructure/availability-zones`
- Parent region: `/aws/service/global-infrastructure/availability-zones/{az-id}/parent-region`

**Services:**

- Path: `/aws/service/global-infrastructure/services`
- Long names: `/aws/service/global-infrastructure/services/{code}/longName`

**Service by Region:**

- Path: `/aws/service/global-infrastructure/regions/{region}/services`

**RSS Feed:**

- URL: `https://docs.aws.amazon.com/global-infrastructure/latest/regions/regions.rss`
- Purpose: Launch dates and blog URLs

## Field Definitions

### Common Fields

| Field | Type | Required | Description | Constraints |
|-------|------|----------|-------------|-------------|
| `timestamp` | string | Yes | ISO 8601 UTC timestamp | Must be valid ISO 8601 |
| `source` | string | Yes | Data source identifier | Always "ssm" since v1.3.0 |
| `count` | number | Yes | Total items in array | Must match array length |

### Region Fields

| Field | Type | Required | Description | Can Be Null |
|-------|------|----------|-------------|-------------|
| `code` | string | Yes | AWS region code | No |
| `name` | string | Yes | Official region name | No |
| `availabilityZones` | number | Yes | AZ count in region | No |
| `launchDate` | string | Yes | RFC 822 launch date | Yes (China/GovCloud) |
| `blogUrl` | string | Yes | AWS announcement URL | Yes (China/GovCloud) |

### Service Fields

| Field | Type | Required | Description | Can Be Null |
|-------|------|----------|-------------|-------------|
| `code` | string | Yes | Service identifier | No |
| `name` | string | Yes | Official service name | No |

### Metadata Fields

| Field | Type | Required | Description | Notes |
|-------|------|----------|-------------|-------|
| `tool` | string | Yes | Tool identifier | Always "nodejs-aws-fetcher" |
| `version` | string | Yes | Schema version | Semantic versioning (e.g., "1.4.0") |
| `timestamp` | string | Yes | Generation timestamp | ISO 8601 UTC |

## File Size Expectations

| File | Without Mapping | With Mapping | Notes |
|------|----------------|--------------|-------|
| `regions.json` | ~8 KB | ~8 KB | Not affected by mapping |
| `services.json` | ~8 KB | ~8 KB | Not affected by mapping |
| `complete-data.json` | ~12 KB | ~400 KB | Significant increase with mapping |

## Performance Characteristics

### Data Freshness

- **Source**: AWS SSM Parameter Store (authoritative)
- **Update Frequency**: Run fetcher as needed (daily recommended)
- **Cache TTL**: 24 hours (configurable)

### Data Consistency

- **Regions**: Stable (rarely change, ~1-2 new regions per year)
- **Services**: Frequently updated (AWS launches services regularly)
- **Service Names**: Always current (fetched dynamically from SSM)
- **AZ Counts**: Stable (AWS rarely adds AZs to existing regions)

## Usage Recommendations

### For Reporter Applications

1. **Always use `complete-data.json`** as the single source of truth
2. **Check `metadata.version`** to ensure schema compatibility
3. **Validate timestamps** to ensure data freshness
4. **Handle null values** gracefully for `launchDate` and `blogUrl`
5. **Use `services.json`** to get full service names (not in `complete-data.json` services array)

### Consumption Pattern (JavaScript)

```javascript
// Load complete data
const data = require('./output/complete-data.json');

// Validate schema version (major version compatibility)
const [major, minor, patch] = data.metadata.version.split('.').map(Number);
if (major !== 1) {
  throw new Error(`Incompatible schema version: ${data.metadata.version}`);
}

// Safe to access v1.x fields
const regions = data.regions.regions;
const services = data.services.services; // Array of codes

// Load full service names from services.json if needed
const servicesWithNames = require('./output/services.json');
```

### Consumption Pattern (Python)

```python
import json
from datetime import datetime

# Load complete data
with open('output/complete-data.json', 'r') as f:
    data = json.load(f)

# Validate schema version
major_version = int(data['metadata']['version'].split('.')[0])
if major_version != 1:
    raise ValueError(f"Incompatible schema version: {data['metadata']['version']}")

# Parse timestamp
timestamp = datetime.fromisoformat(data['metadata']['timestamp'].replace('Z', '+00:00'))

# Access data
regions = data['regions']['regions']
services = data['services']['services']  # List of codes

# Load full service names if needed
with open('output/services.json', 'r') as f:
    services_with_names = json.load(f)
```

## Error Handling

### Missing Fields

If a required field is missing, consider the data invalid:

```javascript
if (!data.metadata || !data.metadata.version) {
  throw new Error('Invalid data: missing required metadata');
}
```

### Null Values

Handle null values gracefully (valid for China/GovCloud regions):

```javascript
const launchDate = region.launchDate || 'Unknown';
const blogUrl = region.blogUrl || 'Not available';
```

### Version Mismatch

Check major version compatibility:

```javascript
const [major] = data.metadata.version.split('.').map(Number);
if (major > 1) {
  console.warn('Data format may have breaking changes, proceed with caution');
}
```

## Migration Guide

### From v1.3.0 to v1.4.0

**Added fields (backward compatible):**

- `regions[].availabilityZones` - number
- `regions[].launchDate` - string|null
- `regions[].blogUrl` - string|null

**Changed fields:**

- `complete-data.json` services are now codes only (not full objects)

**Migration steps:**

1. Update parser to handle new region fields
2. Handle null values for `launchDate` and `blogUrl`
3. Load `services.json` separately for full service names

## Testing & Validation

### Manual Validation

```bash
# Validate JSON syntax
cat output/complete-data.json | jq . > /dev/null && echo "Valid JSON"

# Check region count
jq '.regions.count' output/complete-data.json

# Verify count matches array length
jq '.regions.count == (.regions.regions | length)' output/complete-data.json

# Check for null values
jq '.regions.regions[] | select(.launchDate == null) | .code' output/complete-data.json
```

### Automated Validation

```javascript
// validate-data.js
const fs = require('fs');

function validateCompleteData(filepath) {
  const data = JSON.parse(fs.readFileSync(filepath, 'utf8'));

  // Check metadata
  if (!data.metadata || !data.metadata.version) {
    throw new Error('Missing metadata');
  }

  // Check regions if present
  if (data.regions) {
    if (data.regions.count !== data.regions.regions.length) {
      throw new Error('Region count mismatch');
    }

    // Validate each region
    data.regions.regions.forEach(region => {
      if (!region.code || !region.name || typeof region.availabilityZones !== 'number') {
        throw new Error(`Invalid region: ${JSON.stringify(region)}`);
      }
    });
  }

  console.log('✅ Data validation passed');
}

validateCompleteData('./output/complete-data.json');
```

## Schema Evolution Policy

### Adding New Fields

New optional fields can be added in minor versions:

```json
{
  "regions": [
    {
      "code": "us-east-1",
      "name": "US East (N. Virginia)",
      "availabilityZones": 6,
      "newOptionalField": "value"  // ✅ OK in minor version
    }
  ]
}
```

### Removing Fields

Field removal requires major version bump:

```json
{
  "regions": [
    {
      "code": "us-east-1",
      "name": "US East (N. Virginia)"
      // ❌ Removing availabilityZones requires v2.0.0
    }
  ]
}
```

### Changing Types

Type changes require major version bump:

```json
{
  "regions": {
    "count": "38"  // ❌ Changing from number to string requires v2.0.0
  }
}
```

## Support & Feedback

For questions or issues with this data contract:

1. **GitHub Issues**: <https://github.com/your-repo/nodejs-aws-fetcher/issues>
2. **Documentation**: See `README.md` and `CLAUDE.md`
3. **Version Info**: Check `CHANGELOG.md` for detailed version history

## Appendix: Complete Type Definitions (TypeScript)

```typescript
// Type definitions for nodejs-aws-fetcher output

interface Metadata {
  timestamp: string; // ISO 8601
  tool: 'nodejs-aws-fetcher';
  version: string; // Semantic version (e.g., "1.4.0")
}

interface Region {
  code: string; // Pattern: /^[a-z]{2}-[a-z]+-\d+$/
  name: string; // Official AWS name
  availabilityZones: number; // AZ count
  launchDate: string | null; // RFC 822 format or null
  blogUrl: string | null; // HTTPS URL or null
}

interface RegionData {
  count: number;
  regions: Region[];
  source: 'ssm';
  timestamp: string; // ISO 8601
}

interface Service {
  code: string; // Pattern: /^[a-z0-9-]+$/
  name: string; // Official AWS name
}

interface ServiceData {
  count: number;
  services: Service[];
  source: 'ssm';
  timestamp: string; // ISO 8601
}

interface ServiceByRegion {
  regionCode: string;
  serviceCount: number;
  services: string[]; // Array of service codes
  lastFetched: string; // ISO 8601
}

interface ServicesByRegionData {
  byRegion: Record<string, ServiceByRegion>;
  summary: {
    totalRegions: number;
    totalServices: number;
    averageServicesPerRegion: number;
    cachedRegions: number;
    fetchedRegions: number;
    timestamp: string; // ISO 8601
  };
}

interface CompleteData {
  metadata: Metadata;
  regions?: RegionData;
  services?: {
    count: number;
    services: string[]; // Array of codes only
    source: 'ssm';
    timestamp: string; // ISO 8601
  };
  servicesByRegion?: ServicesByRegionData;
}
```

---

**End of Data Contract**
This document is the formal specification for JSON output from nodejs-aws-fetcher.
Changes to this contract follow semantic versioning principles.
